/**
 * One-time script: builds CKEditor 5 Russian translations for use without CDN.
 * Usage:
 *   node build-ckeditor-ru.js              — download from CDN and build
 *   node build-ckeditor-ru.js ru.js        — build from local ru.js (e.g. saved from CDN)
 */
const https = require('https');
const fs = require('fs');
const path = require('path');

const outPath = path.join(__dirname, 'public', 'js', 'ckeditor-translations-ru.js');

function processData(data) {
    const match = data.match(/export default (\{.+?\});?\s*$/s);
    if (!match) {
      console.error('Could not find export default in response');
      process.exit(1);
    }
    const raw = match[1];
    const ruMatch = raw.match(/^\{?\s*"ru"\s*:\s*(\{.+\})\s*\}\s*$/s);
    if (!ruMatch) {
      console.error('Could not extract ru object');
      process.exit(1);
    }
    const ruStr = ruMatch[1];
    const idx = ruStr.indexOf(',getPluralForm(');
    if (idx === -1) {
      console.error('Could not find getPluralForm in ru object');
      process.exit(1);
    }
    const dictionaryPart = ruStr.substring(0, idx) + '}';
    let dictionary;
    try {
      const parsed = JSON.parse(dictionaryPart);
      dictionary = parsed.dictionary;
    } catch (e) {
      console.error('Failed to parse dictionary:', e.message);
      process.exit(1);
    }
    const getPluralForm = 'function(n){return (n % 10 == 1 && n % 100 != 11 ? 0 : n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20) ? 1 : 2);}';
    const out = [
      '/* Russian translations for CKEditor 5 (local, no CDN). Generated by build-ckeditor-ru.js */',
      'window.CKEDITOR_TRANSLATIONS = window.CKEDITOR_TRANSLATIONS || {};',
      "window.CKEDITOR_TRANSLATIONS['ru'] = {",
      '  dictionary: ' + JSON.stringify(dictionary) + ',',
      '  getPluralForm: ' + getPluralForm,
      '};'
    ].join('\n');
    fs.mkdirSync(path.dirname(outPath), { recursive: true });
    fs.writeFileSync(outPath, out, 'utf8');
    console.log('Written:', outPath);
}

const localFile = process.argv[2];
if (localFile && fs.existsSync(localFile)) {
  const data = fs.readFileSync(localFile, 'utf8');
  processData(data);
} else {
  const url = 'https://cdn.ckeditor.com/ckeditor5/44.3.0/translations/ru.js';
  https.get(url, (res) => {
    let data = '';
    res.on('data', (c) => { data += c; });
    res.on('end', () => processData(data));
  }).on('error', (e) => {
    console.error('Download failed. Save https://cdn.ckeditor.com/ckeditor5/44.3.0/translations/ru.js as ru.js and run: node build-ckeditor-ru.js ru.js');
    process.exit(1);
  });
}
